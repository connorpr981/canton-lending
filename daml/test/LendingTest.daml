-- | Daml Script tests for the Canton Lending Platform
-- Tests the full loan lifecycle and authorization rules
module LendingTest where

import Daml.Script
import Lending.LoanRequest
import Lending.Loan
import Lending.Types
import DA.Date (date, Month(..))

-- | Full lifecycle test: Request -> Accept -> Fund -> Repay -> Close
testFullLoanLifecycle : Script ()
testFullLoanLifecycle = script do
  -- Setup parties
  alice <- allocateParty "Alice"  -- Borrower
  bank <- allocateParty "Bank"    -- Lender

  let today = date 2025 Jan 15

  -- Step 1: Alice creates a loan request
  requestCid <- submit alice do
    createCmd LoanRequest with
      borrower = alice
      lender = bank
      asset = "USD"
      principal = 10000.0
      interestRate = 0.05  -- 5% annual
      termDays = 30
      requestDate = today

  -- Step 2: Bank accepts the request
  loanCid <- submit bank do
    exerciseCmd requestCid Accept

  -- Verify loan is in Proposed state
  Some loan <- queryContractId bank loanCid
  assert (loan.status == Proposed)

  -- Step 3: Bank funds the loan
  fundedLoanCid <- submit bank do
    exerciseCmd loanCid Fund

  -- Verify loan is in Funded state
  Some fundedLoan <- queryContractId bank fundedLoanCid
  assert (fundedLoan.status == Funded)

  -- Step 4: Alice repays
  repaidLoanCid <- submit alice do
    exerciseCmd fundedLoanCid Repay

  -- Verify loan is in Repaid state
  Some repaidLoan <- queryContractId alice repaidLoanCid
  assert (repaidLoan.status == Repaid)

  -- Step 5: Bank closes the loan
  submit bank do
    exerciseCmd repaidLoanCid Close

  -- Verify loan is archived (no longer visible)
  closedLoan <- queryContractId bank repaidLoanCid
  assert (closedLoan == None)

  return ()

-- | Test that lender can reject a loan request
testLoanRejection : Script ()
testLoanRejection = script do
  alice <- allocateParty "Alice"
  bank <- allocateParty "Bank"

  let today = date 2025 Jan 15

  requestCid <- submit alice do
    createCmd LoanRequest with
      borrower = alice
      lender = bank
      asset = "USD"
      principal = 1000000.0  -- Large amount bank might reject
      interestRate = 0.03
      termDays = 365
      requestDate = today

  -- Bank rejects
  submit bank do
    exerciseCmd requestCid Reject

  -- Verify request is archived
  rejectedRequest <- queryContractId bank requestCid
  assert (rejectedRequest == None)

  return ()

-- | Test that borrower can cancel their own request
testBorrowerCancel : Script ()
testBorrowerCancel = script do
  alice <- allocateParty "Alice"
  bank <- allocateParty "Bank"

  let today = date 2025 Jan 15

  requestCid <- submit alice do
    createCmd LoanRequest with
      borrower = alice
      lender = bank
      asset = "USD"
      principal = 5000.0
      interestRate = 0.04
      termDays = 60
      requestDate = today

  -- Alice cancels her own request
  submit alice do
    exerciseCmd requestCid Cancel

  -- Verify request is archived
  cancelledRequest <- queryContractId alice requestCid
  assert (cancelledRequest == None)

  return ()

-- | Test authorization - borrower cannot fund a loan
testUnauthorizedFund : Script ()
testUnauthorizedFund = script do
  alice <- allocateParty "Alice"
  bank <- allocateParty "Bank"

  let today = date 2025 Jan 15

  requestCid <- submit alice do
    createCmd LoanRequest with
      borrower = alice
      lender = bank
      asset = "USD"
      principal = 5000.0
      interestRate = 0.04
      termDays = 60
      requestDate = today

  loanCid <- submit bank do
    exerciseCmd requestCid Accept

  -- Alice (borrower) tries to fund - should fail
  submitMustFail alice do
    exerciseCmd loanCid Fund

  return ()

-- | Test authorization - lender cannot repay a loan
testUnauthorizedRepay : Script ()
testUnauthorizedRepay = script do
  alice <- allocateParty "Alice"
  bank <- allocateParty "Bank"

  let today = date 2025 Jan 15

  requestCid <- submit alice do
    createCmd LoanRequest with
      borrower = alice
      lender = bank
      asset = "USD"
      principal = 5000.0
      interestRate = 0.04
      termDays = 60
      requestDate = today

  loanCid <- submit bank do
    exerciseCmd requestCid Accept

  fundedLoanCid <- submit bank do
    exerciseCmd loanCid Fund

  -- Bank (lender) tries to repay - should fail
  submitMustFail bank do
    exerciseCmd fundedLoanCid Repay

  return ()

-- | Test state machine - cannot fund an already funded loan
testCannotDoubleFund : Script ()
testCannotDoubleFund = script do
  alice <- allocateParty "Alice"
  bank <- allocateParty "Bank"

  let today = date 2025 Jan 15

  requestCid <- submit alice do
    createCmd LoanRequest with
      borrower = alice
      lender = bank
      asset = "USD"
      principal = 5000.0
      interestRate = 0.04
      termDays = 60
      requestDate = today

  loanCid <- submit bank do
    exerciseCmd requestCid Accept

  fundedLoanCid <- submit bank do
    exerciseCmd loanCid Fund

  -- Cannot fund again (old contract is consumed anyway, but the new one is in Funded state)
  submitMustFail bank do
    exerciseCmd fundedLoanCid Fund

  return ()

-- | Test state machine - cannot repay before funding
testCannotRepayBeforeFund : Script ()
testCannotRepayBeforeFund = script do
  alice <- allocateParty "Alice"
  bank <- allocateParty "Bank"

  let today = date 2025 Jan 15

  requestCid <- submit alice do
    createCmd LoanRequest with
      borrower = alice
      lender = bank
      asset = "USD"
      principal = 5000.0
      interestRate = 0.04
      termDays = 60
      requestDate = today

  loanCid <- submit bank do
    exerciseCmd requestCid Accept

  -- Cannot repay a loan that hasn't been funded
  submitMustFail alice do
    exerciseCmd loanCid Repay

  return ()

-- | Test interest calculation
testInterestCalculation : Script ()
testInterestCalculation = script do
  alice <- allocateParty "Alice"
  bank <- allocateParty "Bank"

  let today = date 2025 Jan 15

  requestCid <- submit alice do
    createCmd LoanRequest with
      borrower = alice
      lender = bank
      asset = "USD"
      principal = 10000.0
      interestRate = 0.05  -- 5% annual
      termDays = 365       -- Full year
      requestDate = today

  loanCid <- submit bank do
    exerciseCmd requestCid Accept

  -- Check the loan details
  Some loan <- queryContractId bank loanCid
  -- Interest for 1 year at 5% on 10000 = 500
  assert (loan.interest == 500.0)
  assert (loan.principal == 10000.0)

  -- Get amount due using the helper choice
  amountDue <- submit bank do
    exerciseCmd loanCid GetAmountDue

  assert (amountDue == 10500.0)

  return ()

-- | Test invalid loan request - zero principal
testInvalidZeroPrincipal : Script ()
testInvalidZeroPrincipal = script do
  alice <- allocateParty "Alice"
  bank <- allocateParty "Bank"

  let today = date 2025 Jan 15

  -- Should fail due to ensure clause
  submitMustFail alice do
    createCmd LoanRequest with
      borrower = alice
      lender = bank
      asset = "USD"
      principal = 0.0  -- Invalid!
      interestRate = 0.05
      termDays = 30
      requestDate = today

  return ()

-- | Test invalid loan request - negative term
testInvalidNegativeTerm : Script ()
testInvalidNegativeTerm = script do
  alice <- allocateParty "Alice"
  bank <- allocateParty "Bank"

  let today = date 2025 Jan 15

  -- Should fail due to ensure clause
  submitMustFail alice do
    createCmd LoanRequest with
      borrower = alice
      lender = bank
      asset = "USD"
      principal = 1000.0
      interestRate = 0.05
      termDays = -30  -- Invalid!
      requestDate = today

  return ()
